// Backup copy of templates-editor.js created automatically
// Timestamp: 2025-11-27 00:00:00 (updated snapshot)
// This is a snapshot backup of the current editor script.
// Do not edit this file directly; edit the source at public/js/templates-editor.js
// -----------------------------------------------------------------------------

// Full copy follows:

// Compact minimal TemplatesEditor to restore palette -> canvas DnD and basic API
(function(){
  'use strict';

  var snippets = window.__TEMPLATES_SNIPPETS || {
    hero: '<section class="hero"><h2>Hero</h2></section>',
    card: '<div class="card">Card</div>'
  };
  // ensure common palette snippets exist (fallbacks)
  try{
    if (!snippets['two-col']){
      snippets['two-col'] = '<div class="row g-3">\n  <div class="col-md-6">\n    <div class="card p-3">\n      <h5>Columna 1</h5>\n      <p>Contenido.</p>\n    </div>\n  </div>\n  <div class="col-md-6">\n    <div class="card p-3">\n      <h5>Columna 2</h5>\n      <p>Contenido.</p>\n    </div>\n  </div>\n</div>\n';
    }
  }catch(e){}
  // small guard to avoid duplicate inserts on rapid repeated events
  window.__templates_last_inserted = window.__templates_last_inserted || { content: '', time: 0 };

  function byId(id){ return document.getElementById(id); }

  // deepElementFromPoint: finds the deepest element at coordinates, traversing shadow roots
  function deepElementFromPoint(docOrNode, x, y){
    try{
      var root = docOrNode;
      if (root instanceof Window) root = root.document;
      var el = root.elementFromPoint(x, y);
      if (!el) return null;
      // if element has shadowRoot, try inside it
      if (el.shadowRoot){ var inner = el.shadowRoot.elementFromPoint(x, y); if (inner) return deepElementFromPoint(el.shadowRoot, x, y) || inner; }
      // also check assigned nodes for slots
      if (el.tagName && el.tagName.toLowerCase() === 'slot'){ try{ var assigned = el.assignedElements && el.assignedElements(); if (assigned && assigned.length){ for (var i=0;i<assigned.length;i++){ var candidate = deepElementFromPoint(assigned[i].getRootNode ? assigned[i].getRootNode() : document, x, y); if (candidate) return candidate; } } }catch(e){}
      }
      return el;
    }catch(e){ return null; }
  }

  function getCanvas(){ var el = byId('templatesCanvas'); if (el) return el; try{ return document.querySelector('.templates-canvas'); }catch(e){ return null; } }

  function syncCanvasToTextarea(){
    try{
  var ta = byId('templatesEditor'); if(!ta) return; var c = getCanvas(); if(!c) return;
  ta.value = Array.from(c.children).filter(function(ch){ return ch && ch.classList && ch.classList.contains('tpl-block'); }).map(function(b){ var ct = b.querySelector('.tpl-content'); if (!ct) return b.innerHTML; if (b.__usesShadow && b.__shadowRoot) return serializeShadowContent(b.__shadowRoot); return ct ? ct.innerHTML : b.innerHTML; }).join('\n');
    }catch(e){}
  }

  function addBlockToCanvas(html){
    var c = getCanvas(); if(!c) return;
    try{ // if html is a plain snippet key like 'two-col', map to actual HTML
      if (typeof html === 'string' && html && html.indexOf('<')===-1 && snippets[html]){ html = snippets[html]; }
    }catch(e){}
    var wrap=document.createElement('div'); wrap.className='tpl-block'; wrap.style.margin='8px 0';
    var content=document.createElement('div'); content.className='tpl-content'; wrap.appendChild(content);
    try{ wrap.setAttribute('draggable','true'); }catch(e){}
    // create shadow-isolated preview content
    try{ createShadowContent(content, html || '', wrap); }catch(e){}
    try{ createBlockControls(wrap); }catch(e){}
    c.appendChild(wrap);
    try{ wrap.scrollIntoView({behavior:'smooth', block:'nearest'}); }catch(e){}
    try{ applyLayoutPreview(c); }catch(e){}
    try{ enforceInlineLayout(c); }catch(e){}
    syncCanvasToTextarea();
  }

  // Create shadow-root based content to isolate from global CSS
  function createShadowContent(hostEl, html, block){
    try{
      hostEl.innerHTML = '';
      var host = document.createElement('div'); host.className = 'tpl-preview-host';
      hostEl.appendChild(host);
      var sr = null;
      try{ sr = host.attachShadow({mode:'open'}); }catch(e){ sr = null; }
      if (!sr){ // fallback to normal innerHTML if shadow not available
  hostEl.innerHTML = html;
  block.__usesShadow = false;
  return;
      }
      block.__usesShadow = true;
      block.__shadowHost = host;
      block.__shadowRoot = sr;
      // scoped styles for rows/cols and media inside the shadow root
      var css =
        ':host{display:block;box-sizing:border-box;padding:0;margin:0}\n' +
        '.row{display:flex;flex-wrap:wrap;gap:12px;align-items:stretch}\n' +
        '[class*="col-"]{box-sizing:border-box}\n' +
        '.col-6,.col-md-6{flex:0 0 50%;max-width:50%}\n' +
        '.col-4,.col-md-4{flex:0 0 33.3333%;max-width:33.3333%}\n' +
        '.col-12,.col-md-12{flex:0 0 100%;max-width:100%}\n' +
        '.col,[class*="col-"]{flex:1 1 0;min-width:0}\n' +
        'img,video{max-width:100%;height:auto;display:block}';
      var st = document.createElement('style'); st.textContent = css; sr.appendChild(st);
      // insert the HTML
      var wrapper = document.createElement('div'); wrapper.innerHTML = html || '';
      // move children into shadow root
      while(wrapper.firstChild){ sr.appendChild(wrapper.firstChild); }
    }catch(e){ try{ hostEl.innerHTML = html; block.__usesShadow = false; }catch(ee){} }
  }

  function serializeShadowContent(sr){
    try{
      if (!sr) return '';
      var out = '';
      Array.from(sr.childNodes).forEach(function(n){ try{ if (n.outerHTML) out += n.outerHTML; else if (n.textContent) out += n.textContent; }catch(e){} });
      return out;
    }catch(e){ return ''; }
  }
  
  // Apply inline styles so rows/columns render correctly inside the canvas editor
  function applyLayoutPreview(root){
    try{
      root = root || getCanvas(); if(!root) return;
      var rows = root.querySelectorAll ? root.querySelectorAll('.row') : [];
      var canvasWidth = (root && root.clientWidth) || (document.body.clientWidth || window.innerWidth);
      Array.from(rows).forEach(function(row){
        try{
          // make the row a flex container so bootstrap-like cols render as columns
          row.style.display = 'flex';
          row.style.flexWrap = 'wrap';
          row.style.gap = row.style.gap || '12px';
          Array.from(row.children).forEach(function(col){
            if (!col || !col.classList) return;
            // detect col size classes like col-md-6 or col-6
            var width = null; var breakpoint = null;
            Array.from(col.classList).forEach(function(cls){
              var m = cls.match(/^col-(\d{1,2})$/);
              if (m){ width = (parseInt(m[1],10)/12*100) + '%'; breakpoint = 0; }
              var m2 = cls.match(/^col-(sm|md|lg|xl|xxl)-(\d{1,2})$/);
              if (m2){ var bp = m2[1]; var n = parseInt(m2[2],10); var map = { sm:576, md:768, lg:992, xl:1200, xxl:1400 }; var bpPx = map[bp] || 0; if (!width || bpPx <= canvasWidth){ width = (n/12*100) + '%'; breakpoint = bpPx; }
              }
            });
            if (width){
              // if canvas is narrower than the breakpoint, stack vertically
              if (breakpoint && canvasWidth < breakpoint){ col.style.flex = '1 1 100%'; col.style.maxWidth = '100%'; }
              else { col.style.flex = '0 0 ' + width; col.style.maxWidth = width; }
            } else {
              // generic col => flexible
              if (col.classList.contains('col') || col.className.indexOf('col-')!==-1){ col.style.flex = '1 1 0'; col.style.minWidth = '0'; }
            }
            col.style.boxSizing = 'border-box';
            // ensure media inside columns scale
            Array.from(col.querySelectorAll('img,video')).forEach(function(m){ try{ m.style.maxWidth='100%'; m.style.height='auto'; m.style.display='block'; }catch(e){} });
          });
        }catch(e){}
      });
    }catch(e){}
  }

  // Stronger: enforce inline layout styles on a specific element's rows/cols
  function enforceInlineLayout(root){
    try{
      if (!root) return;
      var rows = root.querySelectorAll ? root.querySelectorAll('.row') : [];
      Array.from(rows).forEach(function(row){
        try{
          // inline styles beat most stylesheet rules, so set them here
          row.style.setProperty('display','flex','important');
          row.style.setProperty('flex-wrap','wrap','important');
          row.style.setProperty('gap','12px','important');
          row.style.setProperty('align-items','stretch','important');
          Array.from(row.children).forEach(function(col){
            if (!col || !col.classList) return;
            // default box sizing
            col.style.setProperty('box-sizing','border-box','important');
            // calc width from classes
            var width = null; var breakpoint = null;
            Array.from(col.classList).forEach(function(cls){
              var m = cls.match(/^col-(\d{1,2})$/);
              if (m){ width = (parseInt(m[1],10)/12*100) + '%'; breakpoint = 0; }
              var m2 = cls.match(/^col-(sm|md|lg|xl|xxl)-(\d{1,2})$/);
              if (m2){ var bp = m2[1]; var n = parseInt(m2[2],10); var map = { sm:576, md:768, lg:992, xl:1200, xxl:1400 }; var bpPx = map[bp] || 0; if (!width || bpPx <= (root.clientWidth||window.innerWidth)){ width = (n/12*100) + '%'; breakpoint = bpPx; }
              }
            });
            if (width){
              if (breakpoint && (root.clientWidth||window.innerWidth) < breakpoint){
                col.style.setProperty('flex','1 1 100%','important');
                col.style.setProperty('max-width','100%','important');
              } else {
                col.style.setProperty('flex','0 0 ' + width,'important');
                col.style.setProperty('max-width', width,'important');
              }
            } else {
              if (col.classList.contains('col') || col.className.indexOf('col-')!==-1){
                col.style.setProperty('flex','1 1 0','important');
                col.style.setProperty('min-width','0','important');
              }
            }
            // ensure media inside columns scale
            Array.from(col.querySelectorAll('img,video')).forEach(function(m){ try{ m.style.setProperty('max-width','100%','important'); m.style.setProperty('height','auto','important'); m.style.setProperty('display','block','important'); }catch(e){} });
          });
        }catch(e){}
      });
    }catch(e){}
  }

  // create block controls: Edit, Delete, Media
  function createBlockControls(block){
    try{
      if (!block || !block.classList) return;
      // avoid duplicate controls
      if (block.querySelector('.tpl-controls')) return;
      var controls = document.createElement('div'); controls.className = 'tpl-controls'; controls.style.margin = '6px 0 0'; controls.style.display = 'flex'; controls.style.gap = '8px';
      // Edit button - toggle inline editing
      var btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.className='tpl-btn-edit'; btnEdit.textContent='Editar'; btnEdit.style.padding='4px 8px';
      // Delete button
      var btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='tpl-btn-del'; btnDel.textContent='Eliminar'; btnDel.style.padding='4px 8px';
      // Media button
      var btnMedia = document.createElement('button'); btnMedia.type='button'; btnMedia.className='tpl-btn-media'; btnMedia.textContent='Media'; btnMedia.style.padding='4px 8px';
      controls.appendChild(btnEdit); controls.appendChild(btnMedia); controls.appendChild(btnDel);
      block.appendChild(controls);

      var content = block.querySelector('.tpl-content');

      btnEdit.addEventListener('click', function(){
        try{
          if (!content) return;
          var isEditing = block.getAttribute('data-editing') === '1';
          if (!isEditing){
            block.setAttribute('data-editing','1');
            // replace content view with textarea
            var ta = document.createElement('textarea'); ta.className='tpl-edit-ta'; ta.style.width='100%'; ta.style.minHeight='80px'; ta.value = content.innerHTML; content.style.display='none'; block.insertBefore(ta, content);
            btnEdit.textContent = 'Guardar';
          } else {
            var ta = block.querySelector('.tpl-edit-ta');
            if (ta){
              var newHtml = ta.value;
              // if block uses shadow, replace its inner shadow content
              if (block.__usesShadow && block.__shadowRoot){
                try{
                  // clear existing
                  while(block.__shadowRoot.firstChild){ block.__shadowRoot.removeChild(block.__shadowRoot.firstChild); }
                  // re-insert new nodes
                  var tmp = document.createElement('div'); tmp.innerHTML = newHtml;
                  while(tmp.firstChild){ block.__shadowRoot.appendChild(tmp.firstChild); }
                }catch(e){ try{ content.innerHTML = newHtml; }catch(ee){} }
              } else {
                try{ content.innerHTML = newHtml; }catch(e){}
              }
              ta.remove();
            }
            content.style.display='block'; block.setAttribute('data-editing','0'); btnEdit.textContent = 'Editar'; syncCanvasToTextarea();
          }
        }catch(e){ console.error('edit block', e); }
      });

      btnDel.addEventListener('click', function(){ try{ if (confirm('Eliminar bloque?')){ block.remove(); syncCanvasToTextarea(); } }catch(e){} });

      // Media flow: show small inline UI to set URL or upload file
      btnMedia.addEventListener('click', function(){
        try{
          // avoid multiple media panels
          if (block.querySelector('.tpl-media-panel')) return;
          var panel = document.createElement('div'); panel.className='tpl-media-panel'; panel.style.marginTop='8px'; panel.style.padding='8px'; panel.style.border='1px dashed #ddd'; panel.style.display='flex'; panel.style.gap='8px'; panel.style.alignItems='center';
          var urlIn = document.createElement('input'); urlIn.type='text'; urlIn.placeholder='URL o data:...'; urlIn.style.flex='1'; urlIn.value = block.getAttribute('data-media') || '';
          var fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*,video/*'; fileIn.style.display='none';
          var btnFile = document.createElement('button'); btnFile.type='button'; btnFile.textContent='Subir'; btnFile.style.padding='4px 8px';
          var btnSave = document.createElement('button'); btnSave.type='button'; btnSave.textContent='Guardar'; btnSave.style.padding='4px 8px';
          var btnCancel = document.createElement('button'); btnCancel.type='button'; btnCancel.textContent='Cerrar'; btnCancel.style.padding='4px 8px';
          panel.appendChild(urlIn); panel.appendChild(btnFile); panel.appendChild(btnSave); panel.appendChild(btnCancel);
          block.appendChild(panel);

          btnFile.addEventListener('click', function(){ try{ fileIn.click(); }catch(e){} });
          fileIn.addEventListener('change', function(){ try{ var f = fileIn.files && fileIn.files[0]; if(!f) return; var reader = new FileReader(); reader.onload = function(ev){ try{ urlIn.value = ev.target.result; }catch(e){} }; reader.readAsDataURL(f); }catch(e){} });

          btnSave.addEventListener('click', function(){ try{ var v = urlIn.value && urlIn.value.trim(); if (!v) return alert('Introduce una URL o sube un archivo'); block.setAttribute('data-media', v); // insert preview
            var prev = block.querySelector('.tpl-media-preview'); if(prev) prev.remove(); var p = document.createElement('div'); p.className='tpl-media-preview'; p.style.marginTop='8px'; if (v.indexOf('data:')===0 || v.match(/^https?:\/\//i) ){ if (v.match(/^data:image|image\//i) || v.match(/\.(png|jpg|jpeg|gif)(\?|$)/i)){ var img = document.createElement('img'); img.src=v; img.style.maxWidth='100%'; p.appendChild(img); } else if (v.match(/youtube.com|youtu.be/i) || v.match(/^data:video|video\//i) || v.match(/\.(mp4|webm|ogg)(\?|$)/i)){ var vid = document.createElement('video'); vid.src=v; vid.controls=true; vid.style.maxWidth='100%'; p.appendChild(vid); } else { var a = document.createElement('a'); a.href=v; a.textContent = v; a.target='_blank'; p.appendChild(a); } } block.appendChild(p); panel.remove(); syncCanvasToTextarea(); }catch(e){ console.error('save media', e); } });

          btnCancel.addEventListener('click', function(){ try{ panel.remove(); }catch(e){} });
        }catch(e){ console.error('open media panel', e); }
      });
    }catch(e){ console.error('createBlockControls', e); }
  }
  
  // enable dragging of existing blocks to reorder
  function wireBlockReorder(){
    var c = getCanvas(); if(!c) return;
    var placeholder = document.createElement('div'); placeholder.className = 'tpl-block-placeholder'; placeholder.style.height = '40px'; placeholder.style.border = '2px dashed #bbb'; placeholder.style.margin = '8px 0';

    function clearPlaceholder(){ try{ if(placeholder.parentNode) placeholder.parentNode.removeChild(placeholder); }catch(e){} }

    c.addEventListener('dragstart', function(ev){
      var target = ev.target;
      if (!target || !target.classList || !target.classList.contains('tpl-block')) return;
      try{ ev.dataTransfer.setData('application/x-templates-block', 'block'); }catch(e){}
      window.__templates_current_drag_block = target;
      // make the block semi-transparent during drag
      try{ target.style.opacity = '0.4'; }catch(e){}
    });

    c.addEventListener('dragend', function(ev){
      try{ var b = window.__templates_current_drag_block; if(b) b.style.opacity = ''; }catch(e){}
      window.__templates_current_drag_block = null;
      clearPlaceholder();
      syncCanvasToTextarea();
    });

    (function(){
      var lastIndex = null;
      c.addEventListener('dragover', function(ev){
        try{
          ev.preventDefault();
          var mouseY = ev.clientY;
          var dragged = window.__templates_current_drag_block;
          // compute list of candidates excluding placeholder and dragged
          var candidates = Array.from(c.children).filter(function(ch){ return ch !== placeholder && ch !== dragged; });
          var insertIndex = candidates.length; // default append
          for (var i=0;i<candidates.length;i++){
            try{
              var r = candidates[i].getBoundingClientRect();
              var mid = r.top + (r.height/2);
              if (mouseY < mid){ insertIndex = i; break; }
            }catch(e){}
          }
          if (insertIndex === lastIndex) return; // no change => avoid reflow oscillation
          lastIndex = insertIndex;
          clearPlaceholder();
          if (insertIndex >= candidates.length){ c.appendChild(placeholder); }
          else { c.insertBefore(placeholder, candidates[insertIndex]); }
        }catch(e){}
      });
    })();

    c.addEventListener('drop', function(ev){
      try{
        ev.preventDefault();
        var draggedBlock = window.__templates_current_drag_block;
        // Only handle moving existing blocks here. Palette drops are handled by wireCanvasDnD.
        if (draggedBlock && draggedBlock.parentNode){
          // insert at placeholder location
          if (placeholder.parentNode === c){
            c.insertBefore(draggedBlock, placeholder);
          } else {
            c.appendChild(draggedBlock);
          }
          clearPlaceholder();
          draggedBlock.style.opacity = '';
          window.__templates_current_drag_block = null;
          syncCanvasToTextarea();
          return;
        }
        // otherwise ignore; palette drops handled elsewhere
      }catch(e){ console.error('TemplatesEditor drop error', e); }
    });
  }

  function wirePalette(){ try{ document.querySelectorAll('.palette-item').forEach(function(p){ try{ p.setAttribute('draggable','true'); }catch(e){} p.addEventListener('click', function(){ var key = p.getAttribute('data-insert'); var html = p.getAttribute('data-html') || (key && snippets[key]) || ''; addBlockToCanvas(html); }); p.addEventListener('dragstart', function(ev){ var key = p.getAttribute('data-insert') || p.getAttribute('data-html') || ''; try{ ev.dataTransfer.setData('application/x-templates-palette', key); }catch(e){ try{ ev.dataTransfer.setData('text/plain', key); }catch(e){} } try{ ev.dataTransfer.effectAllowed='copy'; }catch(e){} window.__templates_current_drag = key; }); p.addEventListener('dragend', function(){ try{ window.__templates_current_drag = null; }catch(e){} }); }); }catch(e){} }

  // track last-clicked column so palette clicks can insert into it
  var __templates_last_clicked_column = null;
  function clearLastClickedColumn(){ try{ if(!__templates_last_clicked_column) return; // remove visual mark from host if column lives in shadow
      try{ var prev = __templates_last_clicked_column; var root = prev.getRootNode && prev.getRootNode(); var hostToUnmark = prev;
        if (root && root.host) hostToUnmark = root.host;
        if (hostToUnmark && hostToUnmark.classList) hostToUnmark.classList.remove('tpl-column-selected');
      }catch(e){}
      __templates_last_clicked_column = null;
    }catch(e){} }
  function setLastClickedColumn(col){ try{ clearLastClickedColumn(); if (!col) return; __templates_last_clicked_column = col; // mark the host element if inside shadow, otherwise mark the column itself
      try{ var root = col.getRootNode && col.getRootNode(); var hostToMark = col; if (root && root.host) hostToMark = root.host; if (hostToMark && hostToMark.classList) hostToMark.classList.add('tpl-column-selected'); }catch(e){} }catch(e){} }

  // enhance palette wiring to respect selected column
  function wirePalette(){
    try{
      document.querySelectorAll('.palette-item').forEach(function(p){
        try{ p.setAttribute('draggable','true'); }catch(e){}
        p.addEventListener('click', function(){
          var key = p.getAttribute('data-insert');
          var html = p.getAttribute('data-html') || (key && snippets[key]) || '';
          try{
            if(__templates_last_clicked_column){ // insert into selected column
              var newBlock = document.createElement('div'); newBlock.className='tpl-block';
              var content = document.createElement('div'); content.className='tpl-content';
              newBlock.appendChild(content);
              try{ newBlock.setAttribute('draggable','true'); }catch(e){}
              try{ createShadowContent(content, html, newBlock); }catch(e){}
              __templates_last_clicked_column.appendChild(newBlock);
              try{ applyLayoutPreview(__templates_last_clicked_column); }catch(e){}
              try{ enforceInlineLayout(__templates_last_clicked_column); }catch(e){}
              syncCanvasToTextarea();
              return;
            }
          }catch(e){}
          addBlockToCanvas(html);
        });
        p.addEventListener('dragstart', function(ev){
          var key = p.getAttribute('data-insert') || p.getAttribute('data-html') || '';
          try{ ev.dataTransfer.setData('application/x-templates-palette', key); }catch(e){ try{ ev.dataTransfer.setData('text/plain', key); }catch(e){} }
          try{ ev.dataTransfer.effectAllowed='copy'; }catch(e){}
          window.__templates_current_drag = key;
        });
        p.addEventListener('dragend', function(){ try{ window.__templates_current_drag = null; }catch(e){} });
      });
    }catch(e){}
  }

  function wireCanvasDnD(){
    var c = getCanvas(); if(!c) return;
    c.addEventListener('dragover', function(ev){ try{ ev.preventDefault(); ev.dataTransfer.dropEffect='copy'; }catch(e){ ev.preventDefault && ev.preventDefault(); } });
    c.addEventListener('drop', function(ev){
      try{
        ev.preventDefault();
        var key = null;
        try{ key = ev.dataTransfer && (ev.dataTransfer.getData('application/x-templates-palette') || ev.dataTransfer.getData('text/plain')); }catch(e){}
        if((!key || key==='') && window.__templates_current_drag) key = window.__templates_current_drag;
        var html = key ? (snippets[key] || key) : '';
        if(!html) return;
        // try find a column under pointer (supports Shadow DOM)
        try{
          var el = deepElementFromPoint(document, ev.clientX, ev.clientY);
          var col = null;
          while(el && el !== document.body){ if (el.classList && (el.classList.contains('tpl-column') || el.classList.contains('tpl-col') || el.classList.contains('col') || el.classList.contains('col-md-6') )){ col = el; break; } el = el.parentNode || (el.host ? el.host : null); }
          if (col){
            var newBlock = document.createElement('div'); newBlock.className='tpl-block';
            var content = document.createElement('div'); content.className='tpl-content'; newBlock.appendChild(content);
            try{ newBlock.setAttribute('draggable','true'); }catch(e){}
            try{ createShadowContent(content, html, newBlock); }catch(e){}
            col.appendChild(newBlock);
            try{ applyLayoutPreview(col); }catch(e){}
            try{ enforceInlineLayout(col); }catch(e){}
            syncCanvasToTextarea();
            return;
          }
        }catch(e){}
        // fallback to append to canvas root
        addBlockToCanvas(html);
      }catch(e){ console.error('TemplatesEditor drop error', e); }
    });
  }

  // allow clicking on columns to select them for palette insertion (supports Shadow DOM via composedPath)
  function wireColumnSelection(){
    try{
      var c = getCanvas(); if(!c) return;
      c.addEventListener('click', function(ev){
        try{
          var path = ev.composedPath ? ev.composedPath() : (function(){ var p=[]; var el = ev.target || ev.srcElement; while(el){ p.push(el); el = el.parentNode; } return p; })();
          for (var i=0;i<path.length;i++){
            try{
              var node = path[i];
              if (!node || !node.classList) continue;
              // match column-like classes
              if (node.classList.contains('tpl-column') || node.classList.contains('tpl-col') || node.classList.contains('col')){ setLastClickedColumn(node); return; }
              // any class starting with col- (col-6, col-md-6, etc.)
              var found = false;
              Array.from(node.classList).forEach(function(cls){ if (/^col(-|$)|^col-(sm|md|lg|xl|xxl)-/.test(cls)) found = true; });
              if (found){ setLastClickedColumn(node); return; }
            }catch(e){}
          }
          // click outside columns clears selection
          clearLastClickedColumn();
        }catch(e){}
      });
    }catch(e){}
  }

  function init(){ try{ wirePalette(); wireCanvasDnD(); }catch(e){} window.TemplatesEditor = window.TemplatesEditor || {}; window.TemplatesEditor.insertHTML = addBlockToCanvas; window.TemplatesEditor.syncBeforeSubmit = function(){ syncCanvasToTextarea(); return true; }; }

  // ensure toolbar buttons are wired after init
  var _origInit2 = init;
  init = function(){ _origInit2(); try{ wireToolbarButtons(); }catch(e){} };

  // inject editor-specific CSS that forces .row/.col to render properly inside the canvas
  function injectEditorStyles(){
    try{
      if (document.getElementById('templates-editor-preview-style')) return;
      var css = ''+
        '.templates-canvas .row, #templatesCanvas .row, .templates-canvas .tpl-content .row, #templatesCanvas .tpl-content .row{ display:flex !important; flex-wrap:wrap !important; gap:12px !important; align-items:stretch !important; }\n'+
        '.templates-canvas .row > [class*="col-"], .templates-canvas .row > [class*="col"], #templatesCanvas .row > [class*="col-"], #templatesCanvas .row > [class*="col"]{ box-sizing:border-box !important; }\n'+
        '.templates-canvas .col-6, .templates-canvas .col-md-6, #templatesCanvas .col-6, #templatesCanvas .col-md-6{ flex:0 0 50% !important; max-width:50% !important; }\n'+
        '.templates-canvas .col-4, .templates-canvas .col-md-4, #templatesCanvas .col-4, #templatesCanvas .col-md-4{ flex:0 0 33.3333% !important; max-width:33.3333% !important; }\n'+
        '.templates-canvas .col-12, .templates-canvas .col-md-12, #templatesCanvas .col-12, #templatesCanvas .col-md-12{ flex:0 0 100% !important; max-width:100% !important; }\n'+
        '.templates-canvas .col, .templates-canvas [class*="col-"], #templatesCanvas .col, #templatesCanvas [class*="col-"]{ flex:1 1 0 !important; min-width:0 !important; }\n'+
        '.templates-canvas .tpl-block, #templatesCanvas .tpl-block{ width:100% !important; box-sizing:border-box !important; }\n'+
        '.templates-canvas .tpl-block .tpl-content img, .templates-canvas .tpl-block .tpl-content video, #templatesCanvas .tpl-block .tpl-content img, #templatesCanvas .tpl-block .tpl-content video{ max-width:100% !important; height:auto !important; display:block !important; }\n'+
        '.tpl-column-selected{ outline:2px dashed rgba(0,123,255,0.45) !important; }\n';
      var st = document.createElement('style'); st.id = 'templates-editor-preview-style'; st.textContent = css; document.head.appendChild(st);
    }catch(e){ }
  }

  // ---------- Preview / toolbar utilities ----------
  function getSerializedCanvasHTML(){
    try{
      var c = getCanvas(); if(!c) return '';
      return Array.from(c.children).filter(function(ch){ return ch && ch.classList && ch.classList.contains('tpl-block'); }).map(function(b){ if (b.__usesShadow && b.__shadowRoot) return serializeShadowContent(b.__shadowRoot); var ct = b.querySelector('.tpl-content'); return ct ? ct.innerHTML : b.innerHTML; }).join('\n');
    }catch(e){ return ''; }
  }

  function createPreviewModal(){
    try{
      if (document.getElementById('templatesRealPreviewModal')) return document.getElementById('templatesRealPreviewModal');
      var st = document.getElementById('tpl-preview-modal-style');
      if (!st){ st = document.createElement('style'); st.id = 'tpl-preview-modal-style'; st.textContent = '\n#templatesRealPreviewModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1050}\n#templatesRealPreviewModal .tpl-modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.55)}\n#templatesRealPreviewModal .tpl-modal-window{position:relative;width:90%;height:85%;max-width:1100px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:1060;display:flex;flex-direction:column}\n#templatesRealPreviewModal .tpl-modal-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f6f6f6;border-bottom:1px solid rgba(0,0,0,0.06)}\n#templatesRealPreviewModal .tpl-modal-body{flex:1;display:block;padding:0;background:#fff}\n#templatesRealPreviewModal iframe{border:0;width:100%;height:100%}\n#templatesRealPreviewModal .tpl-modal-actions{display:flex;gap:8px}\n'; document.head.appendChild(st); }
      var modal = document.createElement('div'); modal.id = 'templatesRealPreviewModal'; modal.style.display = 'none';
      modal.innerHTML = '\n            <div class="tpl-modal-backdrop" data-close="1"></div>\n            <div class="tpl-modal-window">\n              <div class="tpl-modal-header">\n                <div class="tpl-modal-title">Previsualizaci\u00f3n</div>\n                <div class="tpl-modal-actions">\n                  <button type="button" class="btn btn-sm btn-outline-light" id="tplPreviewOpenWindow">Abrir en ventana</button>\n                  <button type="button" class="btn btn-sm btn-outline-danger" id="tplPreviewClose">Cerrar</button>\n                </div>\n              </div>\n              <div class="tpl-modal-body"><iframe id="tplPreviewIframe" sandbox="allow-same-origin allow-forms"></iframe></div>\n            </div>\n';
      document.body.appendChild(modal);
      modal.addEventListener('click', function(ev){ try{ if (ev.target && ev.target.getAttribute && ev.target.getAttribute('data-close')) modal.style.display='none'; }catch(e){} });
      document.getElementById('tplPreviewClose').addEventListener('click', function(){ document.getElementById('templatesRealPreviewModal').style.display='none'; });
      document.getElementById('tplPreviewOpenWindow').addEventListener('click', function(){ try{ var html = getSerializedCanvasHTML(); openPreviewWindowWithHtml(html); }catch(e){ alert('Error al abrir en ventana'); } });
      return modal;
    }catch(e){ return null; }
  }

  function buildPreviewDocument(html){
    try{
      // clone link rel=stylesheet from current document to preserve platform styles
      var links = Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(function(l){ return '<link rel="stylesheet" href="'+ (l.getAttribute('href') || '') +'">'; }).join('\n');
      var inlineStyles = Array.from(document.querySelectorAll('style')).map(function(s){ return '<style>'+ (s.textContent || '') +'</style>'; }).join('\n');
      var base = '<base href="' + (document.baseURI || location.href) + '">';
      return '<!doctype html><html><head><meta charset="utf-8">'+ base + links + inlineStyles +'</head><body>' + (html||'') + '</body></html>';
    }catch(e){ return '<!doctype html><html><head><meta charset="utf-8"></head><body>' + (html||'') + '</body></html>'; }
  }

  function showRealPreview(){
    try{
      var modal = createPreviewModal(); if(!modal) return;
      var iframe = modal.querySelector('#tplPreviewIframe'); if(!iframe) return;
      var html = getSerializedCanvasHTML(); var doc = buildPreviewDocument(html);
      // write into iframe via srcdoc where supported, fallback to document.write
      try{ iframe.srcdoc = doc; }catch(e){ try{ var idoc = iframe.contentWindow && iframe.contentWindow.document; if (idoc){ idoc.open(); idoc.write(doc); idoc.close(); } }catch(ee){} }
      modal.style.display = 'flex';
    }catch(e){ console.error('showRealPreview', e); }
  }

  function openPreviewWindowWithHtml(html){
    try{
      var w = window.open('', '_blank'); if(!w) return alert('Popup bloqueado o no se pudo abrir la ventana');
      var doc = buildPreviewDocument(html);
      w.document.open(); w.document.write(doc); w.document.close();
    }catch(e){ alert('No se pudo abrir la previsualizaci\u00f3n: ' + (e && e.message)); }
  }

  function showHtmlPreviewOverlay(){
    try{
      var existing = document.getElementById('tplHtmlPreviewOverlay');
      if (existing){ existing.remove(); return; }
      var overlay = document.createElement('div'); overlay.id = 'tplHtmlPreviewOverlay'; overlay.style.position='fixed'; overlay.style.inset='8%'; overlay.style.zIndex='1060'; overlay.style.background='rgba(0,0,0,0.7)'; overlay.style.padding='12px'; overlay.style.overflow='auto';
      var box = document.createElement('div'); box.style.background='#fff'; box.style.borderRadius='8px'; box.style.padding='12px'; box.style.maxHeight='100%'; box.style.overflow='auto';
      var ta = document.createElement('textarea'); ta.style.width='100%'; ta.style.height='60vh'; ta.value = getSerializedCanvasHTML(); box.appendChild(ta);
      var close = document.createElement('button'); close.textContent='Cerrar'; close.className='btn btn-sm btn-outline-danger'; close.style.marginTop='8px'; close.addEventListener('click', function(){ overlay.remove(); }); box.appendChild(close);
      overlay.appendChild(box); document.body.appendChild(overlay);
    }catch(e){ console.error('showHtmlPreviewOverlay', e); }
  }

  function clearCanvasConfirm(){ try{ if (!confirm('Limpiar el contenido del editor?')) return; var c = getCanvas(); if(!c) return; Array.from(c.querySelectorAll('.tpl-block')).forEach(function(b){ b.remove(); }); syncCanvasToTextarea(); }catch(e){} }

  // Wire toolbar buttons
  function wireToolbarButtons(){
    try{
      document.querySelectorAll('[data-action="toggle-preview"]').forEach(function(b){ try{ b.addEventListener('click', function(){ showHtmlPreviewOverlay(); }); }catch(e){} });
      var realBtn = document.getElementById('templatesRealPreviewBtn'); if (realBtn) realBtn.addEventListener('click', function(){ showRealPreview(); });
      document.querySelectorAll('[data-action="clear"]').forEach(function(b){ try{ b.addEventListener('click', clearCanvasConfirm); }catch(e){} });
      var openBtn = document.getElementById('btnOpenPreviewWindow') || document.getElementById('tplPreviewOpenWindow'); if (openBtn) openBtn.addEventListener('click', function(){ var html = getSerializedCanvasHTML(); openPreviewWindowWithHtml(html); });
    }catch(e){ }
  }

  // Toggle Visual / HTML views inside the editor area
  function showHtmlPane(){
    try{
      // Prefer using the existing pre#templatesEditorHtmlPane inside the view; fallback to creating a pane
      var canvas = getCanvas(); if(!canvas) return;
      var pre = document.getElementById('templatesEditorHtmlPane');
      if (pre){
        pre.textContent = getSerializedCanvasHTML();
        pre.style.display = 'block';
        // hide visual canvas when showing HTML pane
        try{ var cvs = document.getElementById('templatesCanvas'); if(cvs) cvs.style.display = 'none'; }catch(e){}
        return;
      }
      // fallback: create a simple pane
      var existing = document.getElementById('templatesHtmlPane');
      if (!existing){
        var pane = document.createElement('div'); pane.id = 'templatesHtmlPane'; pane.style.border = '1px solid #ddd'; pane.style.padding = '8px'; pane.style.background = '#fff'; pane.style.maxHeight = '60vh'; pane.style.overflow = 'auto'; pane.style.marginTop = '8px';
        var ta = document.createElement('textarea'); ta.id = 'templatesHtmlTextarea'; ta.style.width = '100%'; ta.style.height = '320px'; ta.value = getSerializedCanvasHTML(); pane.appendChild(ta);
        var btnClose = document.createElement('button'); btnClose.type='button'; btnClose.className='btn btn-sm btn-outline-primary'; btnClose.textContent='Cerrar HTML'; btnClose.style.marginTop='8px'; btnClose.addEventListener('click', function(){ pane.remove(); try{ var cvs = document.getElementById('templatesCanvas'); if(cvs) cvs.style.display=''; }catch(e){} }); pane.appendChild(btnClose);
        canvas.parentNode.insertBefore(pane, canvas.nextSibling);
      } else {
        var ta = document.getElementById('templatesHtmlTextarea'); if (ta) ta.value = getSerializedCanvasHTML();
        existing.style.display = '';
        try{ var cvs2 = document.getElementById('templatesCanvas'); if(cvs2) cvs2.style.display = 'none'; }catch(e){}
      }
    }catch(e){ console.error('showHtmlPane', e); }
  }

  function showVisualPane(){
    try{
      // hide pre pane if present
      var pre = document.getElementById('templatesEditorHtmlPane'); if (pre){ pre.style.display = 'none'; }
      var pane = document.getElementById('templatesHtmlPane'); if (pane) pane.remove();
      try{ var cvs = document.getElementById('templatesCanvas'); if(cvs) cvs.style.display = ''; }catch(e){}
    }catch(e){}
  }

  // Wire optional Visual / HTML buttons if they exist
  function wireViewToggleButtons(){
    try{
      var btnHtml = document.getElementById('btnViewHtml'); if (btnHtml) btnHtml.addEventListener('click', function(){ showHtmlPane(); });
      var btnVis = document.getElementById('btnViewVisual'); if (btnVis) btnVis.addEventListener('click', function(){ showVisualPane(); });
    }catch(e){}
  }

  // Delegation fallback: capture clicks on data-action attributes or IDs in case direct listeners didn't attach
  (function(){
    try{
      document.addEventListener('click', function(ev){
        try{
          var t = ev.target;
          if (!t) return;
          // walk up to find actionable element
          var el = t.closest && t.closest('[data-action], #btnViewHtml, #btnViewVisual');
          if (!el) return;
          var act = el.getAttribute && el.getAttribute('data-action');
          if (el.id === 'btnViewHtml' || act === 'view-html' || act === 'view-html'){
            ev.preventDefault(); showHtmlPane(); return;
          }
          if (el.id === 'btnViewVisual' || act === 'view-visual' || act === 'view-visual'){
            ev.preventDefault(); showVisualPane(); return;
          }
        }catch(e){}
      }, true);
    }catch(e){}
  })();

  // wire reorder after basic init
  var _origInit = init;
  init = function(){ _origInit(); try{ wireBlockReorder(); // ensure existing blocks have controls
  var c = getCanvas(); if(c){ Array.from(c.querySelectorAll('.tpl-block')).forEach(function(b){ try{ createBlockControls(b); }catch(e){} }); try{ applyLayoutPreview(c); }catch(e){} }
      try{ wireColumnSelection(); }catch(e){}
  try{ wireViewToggleButtons(); }catch(e){}
    }catch(e){} };
  // ensure editor styles are present
  try{ injectEditorStyles(); }catch(e){}

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

})();
